"use strict";const _=require("siyuan");function O(){}function ye(t){return t()}function ie(){return Object.create(null)}function q(t){t.forEach(ye)}function me(t){return typeof t=="function"}function be(t,e){return t!=t?e==e:t!==e||t&&typeof t=="object"||typeof t=="function"}function Me(t){return Object.keys(t).length===0}function u(t,e){t.appendChild(e)}function De(t,e,n){const o=Ce(t);if(!o.getElementById(e)){const i=p("style");i.id=e,i.textContent=n,xe(o,i)}}function Ce(t){if(!t)return document;const e=t.getRootNode?t.getRootNode():t.ownerDocument;return e&&e.host?e:t.ownerDocument}function xe(t,e){return u(t.head||t,e),e.sheet}function B(t,e,n){t.insertBefore(e,n||null)}function L(t){t.parentNode&&t.parentNode.removeChild(t)}function Te(t,e){for(let n=0;n<t.length;n+=1)t[n]&&t[n].d(e)}function p(t){return document.createElement(t)}function w(t){return document.createTextNode(t)}function v(){return w(" ")}function Pe(){return w("")}function C(t,e,n,o){return t.addEventListener(e,n,o),()=>t.removeEventListener(e,n,o)}function h(t,e,n){n==null?t.removeAttribute(e):t.getAttribute(e)!==n&&t.setAttribute(e,n)}function qe(t){return Array.from(t.childNodes)}function D(t,e){e=""+e,t.data!==e&&(t.data=e)}function le(t,e,n){for(let o=0;o<t.options.length;o+=1){const i=t.options[o];if(i.__value===e){i.selected=!0;return}}(!n||e!==void 0)&&(t.selectedIndex=-1)}function Le(t){const e=t.querySelector(":checked");return e&&e.__value}function Re(t,e,{bubbles:n=!1,cancelable:o=!1}={}){const i=document.createEvent("CustomEvent");return i.initCustomEvent(t,n,o,e),i}let U;function R(t){U=t}function Ue(){if(!U)throw new Error("Function called outside component initialization");return U}function ve(){const t=Ue();return(e,n,{cancelable:o=!1}={})=>{const i=t.$$.callbacks[e];if(i){const l=Re(e,n,{cancelable:o});return i.slice().forEach(s=>{s.call(t,l)}),!l.defaultPrevented}return!0}}const M=[],se=[];let x=[];const ae=[],Be=Promise.resolve();let Q=!1;function Ie(){Q||(Q=!0,Be.then(we))}function F(t){x.push(t)}const H=new Set;let N=0;function we(){if(N!==0)return;const t=U;do{try{for(;N<M.length;){const e=M[N];N++,R(e),je(e.$$)}}catch(e){throw M.length=0,N=0,e}for(R(null),M.length=0,N=0;se.length;)se.pop()();for(let e=0;e<x.length;e+=1){const n=x[e];H.has(n)||(H.add(n),n())}x.length=0}while(M.length);for(;ae.length;)ae.pop()();Q=!1,H.clear(),R(t)}function je(t){if(t.fragment!==null){t.update(),q(t.before_update);const e=t.dirty;t.dirty=[-1],t.fragment&&t.fragment.p(t.ctx,e),t.after_update.forEach(F)}}function ze(t){const e=[],n=[];x.forEach(o=>t.indexOf(o)===-1?e.push(o):n.push(o)),n.forEach(o=>o()),x=e}const Fe=new Set;function Je(t,e){t&&t.i&&(Fe.delete(t),t.i(e))}function We(t,e,n,o){const{fragment:i,after_update:l}=t.$$;i&&i.m(e,n),o||F(()=>{const s=t.$$.on_mount.map(ye).filter(me);t.$$.on_destroy?t.$$.on_destroy.push(...s):q(s),t.$$.on_mount=[]}),l.forEach(F)}function Ye(t,e){const n=t.$$;n.fragment!==null&&(ze(n.after_update),q(n.on_destroy),n.fragment&&n.fragment.d(e),n.on_destroy=n.fragment=null,n.ctx=[])}function Xe(t,e){t.$$.dirty[0]===-1&&(M.push(t),Ie(),t.$$.dirty.fill(0)),t.$$.dirty[e/31|0]|=1<<e%31}function ke(t,e,n,o,i,l,s,a=[-1]){const r=U;R(t);const c=t.$$={fragment:null,ctx:[],props:l,update:O,not_equal:i,bound:ie(),on_mount:[],on_destroy:[],on_disconnect:[],before_update:[],after_update:[],context:new Map(e.context||(r?r.$$.context:[])),callbacks:ie(),dirty:a,skip_bound:!1,root:e.target||r.$$.root};s&&s(c.root);let k=!1;if(c.ctx=n?n(t,e.props||{},(g,S,...d)=>{const m=d.length?d[0]:S;return c.ctx&&i(c.ctx[g],c.ctx[g]=m)&&(!c.skip_bound&&c.bound[g]&&c.bound[g](m),k&&Xe(t,g)),S}):[],c.update(),k=!0,q(c.before_update),c.fragment=o?o(c.ctx):!1,e.target){if(e.hydrate){const g=qe(e.target);c.fragment&&c.fragment.l(g),g.forEach(L)}else c.fragment&&c.fragment.c();e.intro&&Je(t.$$.fragment),We(t,e.target,e.anchor,e.customElement),we()}R(r)}class Se{$destroy(){Ye(this,1),this.$destroy=O}$on(e,n){if(!me(n))return O;const o=this.$$.callbacks[e]||(this.$$.callbacks[e]=[]);return o.push(n),()=>{const i=o.indexOf(n);i!==-1&&o.splice(i,1)}}$set(e){this.$$set&&!Me(e)&&(this.$$.skip_bound=!0,this.$$set(e),this.$$.skip_bound=!1)}}const V=_.clientApi.createLogger("OpenDiaryToday");function f(...t){V.info(...t)}function $e(...t){V.error(...t)}function Ge(...t){V.warn(...t)}const Oe={"zh-CN":{Setting:[{title:"自动打开 Daily Note",text:"插件启动后自动打开今日的 Daily Note"},{title:"更新笔记本状态",text:"在笔记本配置发生变化的时候更新其状态，也可以使用注册的快捷键 Ctrl+Alt+U"}],Open:"打开日记",Create:"创建日记",UpdateAll:"笔记本状态已更新",Menu:{Move:"移动到"}},"en-US":{Setting:[{title:"Open Today's Diary Automatically",text:"Open Today's Diary automatically when the plugin is loaded"},{title:"Update Notebook Status",text:"Update the status of the notebook when the notebook configuration changes, or use the registered shortcut Ctrl+Alt+U"}],Open:"Open daily note",Create:"Create daily note",UpdateAll:"Notebook status updated",Menu:{Move:"Move to"}}};var pe,_e;const re=(_e=(pe=window==null?void 0:window.siyuan)==null?void 0:pe.config)==null?void 0:_e.lang;let Ee=Oe["zh-CN"];(re===void 0||!re.startsWith("zh"))&&(Ee=Oe["en-US"]);const P=Ee;function He(t){De(t,"svelte-q6yblf","select.svelte-q6yblf{margin:0;min-width:8rem !important;height:100%}")}function ce(t,e,n){const o=t.slice();return o[10]=e[n],o}function Ke(t){let e,n,o=t[10].name+"",i,l,s;return{c(){e=p("option"),n=p("span"),i=w(o),l=v(),h(n,"class","b3-menu__label"),e.__value=s=t[10].id,e.value=e.__value},m(a,r){B(a,e,r),u(e,n),u(n,i),u(e,l)},p(a,r){r&2&&o!==(o=a[10].name+"")&&D(i,o),r&2&&s!==(s=a[10].id)&&(e.__value=s,e.value=e.__value)},d(a){a&&L(e)}}}function Qe(t){let e,n,o,i=t[10].name+"",l,s,a;return{c(){e=p("option"),n=p("span"),o=w("√"),l=w(i),s=v(),h(n,"class","b3-menu__label"),e.__value=a=t[10].id,e.value=e.__value},m(r,c){B(r,e,c),u(e,n),u(n,o),u(n,l),u(e,s)},p(r,c){c&2&&i!==(i=r[10].name+"")&&D(l,i),c&2&&a!==(a=r[10].id)&&(e.__value=a,e.value=e.__value)},d(r){r&&L(e)}}}function ue(t){let e,n;function o(s,a){return a&6&&(e=null),e==null&&(e=!s[10].closed&&s[2].get(s[10].id)===!0),e?Qe:Ke}let i=o(t,-1),l=i(t);return{c(){l.c(),n=Pe()},m(s,a){l.m(s,a),B(s,n,a)},p(s,a){i===(i=o(s,a))&&l?l.p(s,a):(l.d(1),l=i(s),l&&(l.c(),l.m(n.parentNode,n)))},d(s){l.d(s),s&&L(n)}}}function Ve(t){let e,n,o,i=t[1],l=[];for(let s=0;s<i.length;s+=1)l[s]=ue(ce(t,i,s));return{c(){e=p("select");for(let s=0;s<l.length;s+=1)l[s].c();h(e,"class","b3-select svelte-q6yblf"),t[0]===void 0&&F(()=>t[5].call(e))},m(s,a){B(s,e,a);for(let r=0;r<l.length;r+=1)l[r]&&l[r].m(e,null);le(e,t[0],!0),n||(o=[C(e,"click",t[3]),C(e,"blur",t[4]),C(e,"change",t[5])],n=!0)},p(s,[a]){if(a&6){i=s[1];let r;for(r=0;r<i.length;r+=1){const c=ce(s,i,r);l[r]?l[r].p(c,a):(l[r]=ue(c),l[r].c(),l[r].m(e,null))}for(;r<l.length;r+=1)l[r].d(1);l.length=i.length}a&3&&le(e,s[0])},i:O,o:O,d(s){s&&L(e),Te(l,s),n=!1,q(o)}}}function Ze(t,e,n){const o=ve();let{notebooks:i=new Array}=e,{diaryStatus:l=new Map}=e,{selected:s=""}=e,a=!0;function r(d){if(f("Event: click"),a)a=!1,k();else{let m=d.target.value;g(m),a=!0}}function c(){f("Event: blur"),a=!0}function k(){f("Event: openNotebook"),o("openSelector")}function g(d){f("Event: openDiary");let m=i.find(y=>y.id===d);o("openDiary",{notebook:m})}function S(){s=Le(this),n(0,s),n(1,i)}return t.$$set=d=>{"notebooks"in d&&n(1,i=d.notebooks),"diaryStatus"in d&&n(2,l=d.diaryStatus),"selected"in d&&n(0,s=d.selected)},t.$$.update=()=>{t.$$.dirty&1&&f("当前选中",s)},[s,i,l,r,c,S]}class et extends Se{constructor(e){super(),ke(this,e,Ze,Ve,be,{notebooks:1,diaryStatus:2,selected:0},He)}}class tt{constructor(){this.settings={OpenOnStart:!0}}setPlugin(e){this.plugin=e}get(e){var n;return(n=this.settings)==null?void 0:n[e]}set(e,n){this.settings[e]=n}async load(){let e=await(this==null?void 0:this.plugin.loadStorage("DailyNoteToday.json"));if(f(`Read storage: ${e}`),e==null)this.save();else{e=JSON.parse(e);let n=e==null?void 0:e.OpenOnStart;n!=null&&this.set("OpenOnStart",n)}}save(){let e=JSON.stringify(this.settings);f(`Write storage: ${e}`),this.plugin.writeStorage("DailyNoteToday.json",e)}}const T=new tt;function nt(t){let e,n,o,i=t[0][0].title+"",l,s,a,r=t[0][0].text+"",c,k,g,S,d,m,y,E,I=t[0][1].title+"",W,ee,j,z=t[0][1].text+"",Y,te,X,ne,A,G,oe;return{c(){e=p("div"),n=p("label"),o=p("div"),l=w(i),s=v(),a=p("div"),c=w(r),k=v(),g=p("span"),S=v(),d=p("input"),m=v(),y=p("label"),E=p("div"),W=w(I),ee=v(),j=p("div"),Y=w(z),te=v(),X=p("span"),ne=v(),A=p("button"),A.textContent="Update",h(a,"class","b3-label__text"),h(o,"class","fn__flex-1"),h(g,"class","fn__space"),h(d,"class","b3-switch fn__flex-center"),h(d,"id","openDNOnStart"),h(d,"type","checkbox"),h(n,"class","fn__flex b3-label"),h(j,"class","b3-label__text"),h(E,"class","fn__flex-1"),h(X,"class","fn__space"),h(A,"class","b3-button b3-button--outline fn__flex-center fn__size200"),h(A,"id","updateNotebookStatus"),h(y,"class","fn__flex b3-label"),h(e,"class","config__tab-container")},m(b,$){B(b,e,$),u(e,n),u(n,o),u(o,l),u(o,s),u(o,a),u(a,c),u(n,k),u(n,g),u(n,S),u(n,d),d.checked=t[1],u(e,m),u(e,y),u(y,E),u(E,W),u(E,ee),u(E,j),u(j,Y),u(y,te),u(y,X),u(y,ne),u(y,A),G||(oe=[C(d,"change",t[3]),C(d,"change",t[4]),C(A,"click",t[2])],G=!0)},p(b,[$]){$&1&&i!==(i=b[0][0].title+"")&&D(l,i),$&1&&r!==(r=b[0][0].text+"")&&D(c,r),$&2&&(d.checked=b[1]),$&1&&I!==(I=b[0][1].title+"")&&D(W,I),$&1&&z!==(z=b[0][1].text+"")&&D(Y,z)},i:O,o:O,d(b){b&&L(e),G=!1,q(oe)}}}function ot(t,e,n){let o=T.get("OpenOnStart");const i=ve();let{contents:l}=e;function s(){i("updateAll")}function a(){o=this.checked,n(1,o)}const r=c=>{console.log("Checked: "+c.target.checked),T.set("OpenOnStart",c.target.checked),T.save()};return t.$$set=c=>{"contents"in c&&n(0,l=c.contents)},[l,o,s,a,r]}class it extends Se{constructor(e){super(),ke(this,e,ot,nt,be,{contents:0})}}var ge;let lt=(ge=window.siyuan)==null?void 0:ge.config.api.token;async function st(t,e){let o=await(await fetch(t,{body:JSON.stringify(e),method:"POST",headers:{Authorization:`Token ${lt}`}})).json();return o&&(o==null?void 0:o.code)===0?o.data:null}const K='/daily note/{{now | date "2006/01"}}/{{now | date "2006-01-02"}}',at=new Set(["思源笔记用户指南","SiYuan User Guide"]);async function rt(t){let e=`select * from blocks where parent_id = '${t}'`;return await _.serverApi.sql(e)}async function Ae(t,e,n="parent"){let o=new Array;t.type=="h"&&(o=await rt(t.id));let i;n=="parent"?i=await _.serverApi.moveBlock(t.id,null,e):n=="previous"&&(i=await _.serverApi.moveBlock(t.id,e,null)),console.log("Move ans:",i);let l=t.id;for(let s of o){let a=s.id;s.type!="h"?(i=await _.serverApi.moveBlock(a,l,null),l=a):l=await Ae(s,l,"previous")}return l}async function ct(t,e){let n=await _.serverApi.getBlockByID(t);if(n==null){$e(`Block ${t} not found`);return}let o=e.dailynotePath,i=await Z(o,e),l;i!=null&&i.length>0?l=i[0].id:(l=await Ne(e,o),J(`${P.Create}: ${e.name}`,"info",2500)),Ae(n,l,"parent")}async function J(t,e="info",n=1e3){new _.Notification({type:e,message:t,timeout:n}).show()}async function de(){try{let e=(await _.serverApi.lsNotebooks("")).notebooks;e=e.filter(o=>!o.closed&&!at.has(o.name)),e=e.sort((o,i)=>o.sort-i.sort);let n=e.map(o=>o.name);for(let o of e){let i=await ut(o.id);o.dailynoteSprig=i!=""?i:K,o.dailynotePath=await fe(o.dailynoteSprig),o.dailynotePath==""&&(Ge(`Invalid daily note srpig of ${o.name}`),o.dailynoteSprig=K,o.dailynotePath=await fe(K)),f(`${o.name}: ${o.dailynoteSprig} - ${o.dailynotePath}`)}return f(`Read all notebooks: ${n}`),e}catch(t){return $e(t),null}}async function ut(t){return(await _.serverApi.getNotebookConf(t)).conf.dailyNoteSavePath}async function dt(t){return await st("/api/template/renderSprig",{template:t})}async function fe(t){return await dt(t)}async function Z(t,e=null){let n=`select * from blocks where type='d' and hpath = '${t}'`;return e!=null&&(n=`select * from blocks where type='d' and hpath = '${t}' and box = '${e.id}'`),await _.serverApi.sql(n)}async function Ne(t,e){f(`Try to create: ${t.name} ${e}`);let n=await _.serverApi.createDocWithMd(t.id,e,"");return f(`Create new diary ${n}`),n}async function he(t){let e=t.dailynotePath;f(`Open ${t.name}/${e}`);let n=await Z(e,t);if(n!=null&&n.length>0){let i=n[0].id;window.open(`siyuan://blocks/${i}`),J(`${P.Open}： ${t.name}`,"info",2500)}else{let o=await Ne(t,e);window.open(`siyuan://blocks/${o}`),J(`${P.Create}: ${t.name}`,"info",2500)}}class ft{constructor(e){this.notebooks=e}async bindMenuOnCurrentTabs(){let e=document.querySelector("div.protyle-gutters");e==null||e.addEventListener("contextmenu",this.gutterContextMenuEvent.bind(this))}addEditorTabObserver(){let e=document.querySelector("#layouts div.layout__center div.layout-tab-container"),n=i=>{this.gutterContextMenuEvent(i)};var o=new MutationObserver(function(i){for(var l of i){if(l.type=="childList"&&l.addedNodes.length)for(let s of l.addedNodes){let a=s,r=a.querySelector("div.protyle-gutters");r==null||r.addEventListener("contextmenu",n),f(`Add Listener: ${a}`)}if(l.type=="childList"&&l.removedNodes.length)for(let s of l.removedNodes){let a=s,r=a.querySelector("div.protyle-gutters");r==null||r.removeEventListener("contextmenu",n),f(`Remove Listener: ${a}`)}}});e&&o.observe(e,{childList:!0,attributes:!1,characterData:!1,subtree:!1})}gutterContextMenuEvent(e){let n=e.target,o=e.currentTarget;for(;n!=o&&n.tagName!=="BUTTON";)if(n.parentElement)n=n.parentElement;else break;let i=n.getAttribute("data-node-id");if(i&&e.altKey){f(`Contextemnu on: ${i}`);let l=new _.Menu("MoveMenu");l.addItem(new _.MenuItem({label:P.Menu.Move,type:"submenu",icon:"iconMove",submenu:this.createMenuItems(i)})),l.showAtMouseEvent(e)}}createMenuItems(e){let n=[];for(let o of this.notebooks){let i={label:o.name,icon:`icon-${o.icon}`,click:l=>{f(`Move ${e} to ${o.id}`),ct(e,o)}};n.push(i)}return n}}const ht="toolbar__item b3-tooltips b3-tooltips__sw";class pt extends _.Plugin{constructor(){super(),f(`Start: ${new Date}`),T.setPlugin(this),this.notebooks=[],this.selectFolded=!0,this.div_select=document.createElement("div"),this.div_select.setAttribute("aria-label","Open Today's Diary"),this.div_select.classList.add(...ht.split(/\s/)),this.div_select.style.margin="0 0.5rem",this.div_select.style.padding="0rem 0rem",this.menu=new ft(this.notebooks)}async onload(){let e=performance.now();await this.initNotebooks(),this.registerCommand({command:"updateAll",shortcut:"ctrl+alt+u,command+option+u",description:"全局更新",callback:this.updateAll.bind(this)}),await T.load(),this.initSetting(),this.initMenu(),this.component_select=new et({target:this.div_select,props:{notebooks:this.notebooks}}),this.component_select.$on("openSelector",this.updateDiaryStatus_.bind(this)),this.component_select.$on("openDiary",async o=>{await he(o.detail.notebook),this.updateDiaryStatus_()}),_.clientApi.addToolbarRight(this.div_select),await this.updateDiaryStatus_(),this.notebooks.length>0&&(this.component_select.$set({selected:this.notebooks[0].id}),T.settings.OpenOnStart===!0&&he(this.notebooks[0]));let n=performance.now();f(`Onload, 耗时: ${n-e} ms`)}initSetting(){this.div_setting=document.createElement("div"),this.component_setting=new it({target:this.div_setting,props:{contents:P.Setting}}),this.registerSettingRender(e=>{e.appendChild(this.div_setting)}),this.component_setting.$on("updateAll",()=>{this.updateAll()})}initMenu(){this.menu.notebooks=this.notebooks,this.menu.bindMenuOnCurrentTabs(),this.menu.addEditorTabObserver()}async initNotebooks(){let n=0;for(;n<5;){let o=await de();if(o!=null){this.notebooks=o;break}else await new Promise(i=>setTimeout(i,1e3));n++}}async updateAll(){f("updateAll");let e=await de();this.notebooks=e||[],this.component_select.$set({notebooks:this.notebooks}),await this.updateDiaryStatus_(),this.menu.notebooks=this.notebooks,this.menu.bindMenuOnCurrentTabs(),J(P.UpdateAll,"info",2500)}async updateDiaryStatus_(){f("updateDiaryStatus");let e=new Set;this.notebooks.forEach(i=>{e.add(i.dailynotePath)});let n=new Map,o=0;for(const i of e){let l=await Z(i);if(l.length>0){let s=l.map(a=>a.box);s.forEach(a=>{n.set(a,!0)}),o+=s.length,f(`${i} 共 ${s.length} 篇`)}}this.component_select.$set({diaryStatus:n}),f(`当前日记共 ${o} 篇`)}onunload(){f("plugin unload"),this.component_select.$destroy(),this.div_select.remove()}}module.exports=pt;
