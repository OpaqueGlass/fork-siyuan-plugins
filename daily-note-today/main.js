"use strict";const k=require("siyuan");function O(){}function gt(e){return e()}function it(){return Object.create(null)}function R(e){e.forEach(gt)}function mt(e){return typeof e=="function"}function yt(e,t){return e!=e?t==t:e!==t||e&&typeof e=="object"||typeof e=="function"}function Dt(e){return Object.keys(e).length===0}function u(e,t){e.appendChild(t)}function Nt(e,t,n){const i=At(e);if(!i.getElementById(t)){const o=_("style");o.id=t,o.textContent=n,Et(i,o)}}function At(e){if(!e)return document;const t=e.getRootNode?e.getRootNode():e.ownerDocument;return t&&t.host?t:e.ownerDocument}function Et(e,t){return u(e.head||e,t),t.sheet}function L(e,t,n){e.insertBefore(t,n||null)}function U(e){e.parentNode&&e.parentNode.removeChild(e)}function Ct(e,t){for(let n=0;n<e.length;n+=1)e[n]&&e[n].d(t)}function _(e){return document.createElement(e)}function v(e){return document.createTextNode(e)}function b(){return v(" ")}function xt(){return v("")}function x(e,t,n,i){return e.addEventListener(t,n,i),()=>e.removeEventListener(t,n,i)}function f(e,t,n){n==null?e.removeAttribute(t):e.getAttribute(t)!==n&&e.setAttribute(t,n)}function Tt(e){return Array.from(e.childNodes)}function C(e,t){t=""+t,e.data!==t&&(e.data=t)}function ot(e,t,n){for(let i=0;i<e.options.length;i+=1){const o=e.options[i];if(o.__value===t){o.selected=!0;return}}(!n||t!==void 0)&&(e.selectedIndex=-1)}function Pt(e){const t=e.querySelector(":checked");return t&&t.__value}function Rt(e,t,{bubbles:n=!1,cancelable:i=!1}={}){const o=document.createEvent("CustomEvent");return o.initCustomEvent(e,n,i,t),o}let j;function M(e){j=e}function Ut(){if(!j)throw new Error("Function called outside component initialization");return j}function bt(){const e=Ut();return(t,n,{cancelable:i=!1}={})=>{const o=e.$$.callbacks[t];if(o){const a=Rt(t,n,{cancelable:i});return o.slice().forEach(l=>{l.call(e,a)}),!a.defaultPrevented}return!0}}const E=[],lt=[];let T=[];const at=[],Mt=Promise.resolve();let K=!1;function jt(){K||(K=!0,Mt.then(vt))}function F(e){T.push(e)}const G=new Set;let A=0;function vt(){if(A!==0)return;const e=j;do{try{for(;A<E.length;){const t=E[A];A++,M(t),Lt(t.$$)}}catch(t){throw E.length=0,A=0,t}for(M(null),E.length=0,A=0;lt.length;)lt.pop()();for(let t=0;t<T.length;t+=1){const n=T[t];G.has(n)||(G.add(n),n())}T.length=0}while(E.length);for(;at.length;)at.pop()();K=!1,G.clear(),M(e)}function Lt(e){if(e.fragment!==null){e.update(),R(e.before_update);const t=e.dirty;e.dirty=[-1],e.fragment&&e.fragment.p(e.ctx,t),e.after_update.forEach(F)}}function qt(e){const t=[],n=[];T.forEach(i=>e.indexOf(i)===-1?t.push(i):n.push(i)),n.forEach(i=>i()),T=t}const zt=new Set;function Bt(e,t){e&&e.i&&(zt.delete(e),e.i(t))}function Ft(e,t,n,i){const{fragment:o,after_update:a}=e.$$;o&&o.m(t,n),i||F(()=>{const l=e.$$.on_mount.map(gt).filter(mt);e.$$.on_destroy?e.$$.on_destroy.push(...l):R(l),e.$$.on_mount=[]}),a.forEach(F)}function It(e,t){const n=e.$$;n.fragment!==null&&(qt(n.after_update),R(n.on_destroy),n.fragment&&n.fragment.d(t),n.on_destroy=n.fragment=null,n.ctx=[])}function Jt(e,t){e.$$.dirty[0]===-1&&(E.push(e),jt(),e.$$.dirty.fill(0)),e.$$.dirty[t/31|0]|=1<<t%31}function kt(e,t,n,i,o,a,l,s=[-1]){const r=j;M(e);const c=e.$$={fragment:null,ctx:[],props:a,update:O,not_equal:o,bound:it(),on_mount:[],on_destroy:[],on_disconnect:[],before_update:[],after_update:[],context:new Map(t.context||(r?r.$$.context:[])),callbacks:it(),dirty:s,skip_bound:!1,root:t.target||r.$$.root};l&&l(c.root);let w=!1;if(c.ctx=n?n(e,t.props||{},(p,S,...d)=>{const m=d.length?d[0]:S;return c.ctx&&o(c.ctx[p],c.ctx[p]=m)&&(!c.skip_bound&&c.bound[p]&&c.bound[p](m),w&&Jt(e,p)),S}):[],c.update(),w=!0,R(c.before_update),c.fragment=i?i(c.ctx):!1,t.target){if(t.hydrate){const p=Tt(t.target);c.fragment&&c.fragment.l(p),p.forEach(U)}else c.fragment&&c.fragment.c();t.intro&&Bt(e.$$.fragment),Ft(e,t.target,t.anchor,t.customElement),vt()}M(r)}class wt{$destroy(){It(this,1),this.$destroy=O}$on(t,n){if(!mt(n))return O;const i=this.$$.callbacks[t]||(this.$$.callbacks[t]=[]);return i.push(n),()=>{const o=i.indexOf(n);o!==-1&&i.splice(o,1)}}$set(t){this.$$set&&!Dt(t)&&(this.$$.skip_bound=!0,this.$$set(t),this.$$.skip_bound=!1)}}const V=k.clientApi.createLogger("OpenDiaryToday");function h(...e){V.info(...e)}function Wt(...e){V.error(...e)}function Yt(...e){V.warn(...e)}const St={"zh-CN":{Setting:[{title:"自动打开 Daily Note",text:"插件启动后自动打开今日的 Daily Note"},{title:"更新笔记本状态",text:"在笔记本配置发生变化的时候更新其状态，也可以使用注册的快捷键 Ctrl+Alt+U"}],Open:"打开日记",Create:"创建日记",UpdateAll:"笔记本状态已更新"},"en-US":{Setting:[{title:"Open Today's Diary Automatically",text:"Open Today's Diary automatically when the plugin is loaded"},{title:"Update Notebook Status",text:"Update the status of the notebook when the notebook configuration changes, or use the registered shortcut Ctrl+Alt+U"}],Open:"Open daily note",Create:"Create daily note",UpdateAll:"Notebook status updated"}};var ht,_t;const st=(_t=(ht=window==null?void 0:window.siyuan)==null?void 0:ht.config)==null?void 0:_t.lang;let $t=St["zh-CN"];(st===void 0||!st.startsWith("zh"))&&($t=St["en-US"]);const I=$t;function Xt(e){Nt(e,"svelte-yta1l5","select.svelte-yta1l5{margin:0;padding:0;max-width:8rem !important}")}function rt(e,t,n){const i=e.slice();return i[10]=t[n],i}function Gt(e){let t,n,i=e[10].name+"",o,a,l;return{c(){t=_("option"),n=_("span"),o=v(i),a=b(),f(n,"class","b3-menu__label"),t.__value=l=e[10].id,t.value=t.__value,f(t,"class","b3-menu__item")},m(s,r){L(s,t,r),u(t,n),u(n,o),u(t,a)},p(s,r){r&2&&i!==(i=s[10].name+"")&&C(o,i),r&2&&l!==(l=s[10].id)&&(t.__value=l,t.value=t.__value)},d(s){s&&U(t)}}}function Ht(e){let t,n,i,o=e[10].name+"",a,l,s;return{c(){t=_("option"),n=_("span"),i=v("√"),a=v(o),l=b(),f(n,"class","b3-menu__label"),t.__value=s=e[10].id,t.value=t.__value,f(t,"class","b3-menu__item")},m(r,c){L(r,t,c),u(t,n),u(n,i),u(n,a),u(t,l)},p(r,c){c&2&&o!==(o=r[10].name+"")&&C(a,o),c&2&&s!==(s=r[10].id)&&(t.__value=s,t.value=t.__value)},d(r){r&&U(t)}}}function ct(e){let t,n;function i(l,s){return s&6&&(t=null),t==null&&(t=!l[10].closed&&l[2].get(l[10].id)===!0),t?Ht:Gt}let o=i(e,-1),a=o(e);return{c(){a.c(),n=xt()},m(l,s){a.m(l,s),L(l,n,s)},p(l,s){o===(o=i(l,s))&&a?a.p(l,s):(a.d(1),a=o(l),a&&(a.c(),a.m(n.parentNode,n)))},d(l){a.d(l),l&&U(n)}}}function Kt(e){let t,n,i,o=e[1],a=[];for(let l=0;l<o.length;l+=1)a[l]=ct(rt(e,o,l));return{c(){t=_("select");for(let l=0;l<a.length;l+=1)a[l].c();f(t,"class","toolbar__item b3-tooltips b3-tooltips__se svelte-yta1l5"),e[0]===void 0&&F(()=>e[5].call(t))},m(l,s){L(l,t,s);for(let r=0;r<a.length;r+=1)a[r]&&a[r].m(t,null);ot(t,e[0],!0),n||(i=[x(t,"click",e[3]),x(t,"blur",e[4]),x(t,"change",e[5])],n=!0)},p(l,[s]){if(s&6){o=l[1];let r;for(r=0;r<o.length;r+=1){const c=rt(l,o,r);a[r]?a[r].p(c,s):(a[r]=ct(c),a[r].c(),a[r].m(t,null))}for(;r<a.length;r+=1)a[r].d(1);a.length=o.length}s&3&&ot(t,l[0])},i:O,o:O,d(l){l&&U(t),Ct(a,l),n=!1,R(i)}}}function Qt(e,t,n){const i=bt();let{notebooks:o=new Array}=t,{diaryStatus:a=new Map}=t,{selected:l=""}=t,s=!0;function r(d){if(h("Event: click"),s)s=!1,w();else{let m=d.target.value;p(m),s=!0}}function c(){h("Event: blur"),s=!0}function w(){h("Event: openNotebook"),i("openSelector")}function p(d){h("Event: openDiary");let m=o.find(g=>g.id===d);i("openDiary",{notebook:m})}function S(){l=Pt(this),n(0,l),n(1,o)}return e.$$set=d=>{"notebooks"in d&&n(1,o=d.notebooks),"diaryStatus"in d&&n(2,a=d.diaryStatus),"selected"in d&&n(0,l=d.selected)},e.$$.update=()=>{e.$$.dirty&1&&h("当前选中",l)},[l,o,a,r,c,S]}class Vt extends wt{constructor(t){super(),kt(this,t,Qt,Kt,yt,{notebooks:1,diaryStatus:2,selected:0},Xt)}}class Zt{constructor(){this.settings={OpenOnStart:!0}}setPlugin(t){this.plugin=t}get(t){var n;return(n=this.settings)==null?void 0:n[t]}set(t,n){this.settings[t]=n}async load(){let t=await(this==null?void 0:this.plugin.loadStorage("DailyNoteToday.json"));if(h(`Read storage: ${t}`),t==null)this.save();else{t=JSON.parse(t);let n=t==null?void 0:t.OpenOnStart;n!=null&&this.set("OpenOnStart",n)}}save(){let t=JSON.stringify(this.settings);h(`Write storage: ${t}`),this.plugin.writeStorage("DailyNoteToday.json",t)}}const P=new Zt;function te(e){let t,n,i,o=e[0][0].title+"",a,l,s,r=e[0][0].text+"",c,w,p,S,d,m,g,D,q=e[0][1].title+"",J,Z,z,B=e[0][1].text+"",W,tt,Y,et,N,X,nt;return{c(){t=_("div"),n=_("label"),i=_("div"),a=v(o),l=b(),s=_("div"),c=v(r),w=b(),p=_("span"),S=b(),d=_("input"),m=b(),g=_("label"),D=_("div"),J=v(q),Z=b(),z=_("div"),W=v(B),tt=b(),Y=_("span"),et=b(),N=_("button"),N.textContent="Update",f(s,"class","b3-label__text"),f(i,"class","fn__flex-1"),f(p,"class","fn__space"),f(d,"class","b3-switch fn__flex-center"),f(d,"id","openDNOnStart"),f(d,"type","checkbox"),f(n,"class","fn__flex b3-label"),f(z,"class","b3-label__text"),f(D,"class","fn__flex-1"),f(Y,"class","fn__space"),f(N,"class","b3-button b3-button--outline fn__flex-center fn__size200"),f(N,"id","updateNotebookStatus"),f(g,"class","fn__flex b3-label"),f(t,"class","config__tab-container")},m(y,$){L(y,t,$),u(t,n),u(n,i),u(i,a),u(i,l),u(i,s),u(s,c),u(n,w),u(n,p),u(n,S),u(n,d),d.checked=e[1],u(t,m),u(t,g),u(g,D),u(D,J),u(D,Z),u(D,z),u(z,W),u(g,tt),u(g,Y),u(g,et),u(g,N),X||(nt=[x(d,"change",e[3]),x(d,"change",e[4]),x(N,"click",e[2])],X=!0)},p(y,[$]){$&1&&o!==(o=y[0][0].title+"")&&C(a,o),$&1&&r!==(r=y[0][0].text+"")&&C(c,r),$&2&&(d.checked=y[1]),$&1&&q!==(q=y[0][1].title+"")&&C(J,q),$&1&&B!==(B=y[0][1].text+"")&&C(W,B)},i:O,o:O,d(y){y&&U(t),X=!1,R(nt)}}}function ee(e,t,n){let i=P.get("OpenOnStart");const o=bt();let{contents:a}=t;function l(){o("updateAll")}function s(){i=this.checked,n(1,i)}const r=c=>{console.log("Checked: "+c.target.checked),P.set("OpenOnStart",c.target.checked),P.save()};return e.$$set=c=>{"contents"in c&&n(0,a=c.contents)},[a,i,l,s,r]}class ne extends wt{constructor(t){super(),kt(this,t,ee,te,yt,{contents:0})}}var pt;let ie=(pt=window.siyuan)==null?void 0:pt.config.api.token;async function oe(e,t){let i=await(await fetch(e,{body:JSON.stringify(t),method:"POST",headers:{Authorization:`Token ${ie}`}})).json();return i&&(i==null?void 0:i.code)===0?i.data:null}const H='/daily note/{{now | date "2006/01"}}/{{now | date "2006-01-02"}}',le=new Set(["思源笔记用户指南","SiYuan User Guide"]);async function Q(e,t="info",n=1e3){new k.Notification({type:t,message:e,timeout:n}).show()}async function ut(){try{let t=(await k.serverApi.lsNotebooks("")).notebooks;t=t.filter(i=>!i.closed&&!le.has(i.name)),t=t.sort((i,o)=>i.sort-o.sort);let n=t.map(i=>i.name);for(let i of t){let o=await ae(i.id);i.dailynoteSprig=o!=""?o:H,i.dailynotePath=await dt(i.dailynoteSprig),i.dailynotePath==""&&(Yt(`Invalid daily note srpig of ${i.name}`),i.dailynoteSprig=H,i.dailynotePath=await dt(H)),h(`${i.name}: ${i.dailynoteSprig} - ${i.dailynotePath}`)}return h(`Read all notebooks: ${n}`),t}catch(e){return Wt(e),null}}async function ae(e){return(await k.serverApi.getNotebookConf(e)).conf.dailyNoteSavePath}async function se(e){return await oe("/api/template/renderSprig",{template:e})}async function dt(e){return await se(e)}async function Ot(e,t=null){let n=`select * from blocks where type='d' and hpath = '${e}'`;return t!=null&&(n=`select * from blocks where type='d' and hpath = '${e}' and box = '${t.id}'`),await k.serverApi.sql(n)}async function re(e,t){h(`Try to create: ${e.name} ${t}`);let n=await k.serverApi.createDocWithMd(e.id,t,"");return h(`Create new diary ${n}`),n}async function ft(e){let t=e.dailynotePath;h(`Open ${e.name}/${t}`);let n=await Ot(t,e);if(n!=null&&n.length>0){let o=n[0].id;window.open(`siyuan://blocks/${o}`),Q(`${I.Open}： ${e.name}`,"info",2500)}else{let i=await re(e,t);window.open(`siyuan://blocks/${i}`),Q(`${I.Create}: ${e.name}`,"info",2500)}}const ce="toolbar__item b3-tooltips b3-tooltips__sw";class ue extends k.Plugin{constructor(){super(),h(`Start: ${new Date}`),P.setPlugin(this),this.notebooks=[],this.selectFolded=!0,this.div_select=document.createElement("div"),this.div_select.setAttribute("aria-label","Open Today's Diary"),this.div_select.classList.add(...ce.split(/\s/)),this.div_select.style.margin="0 0.5rem",this.div_select.style.padding="0rem 0rem"}async onload(){let t=performance.now();await this.initNotebooks(),this.registerCommand({command:"updateAll",shortcut:"ctrl+alt+u,command+option+u",description:"全局更新",callback:this.updateAll.bind(this)}),await P.load(),this.initSetting(),this.component_select=new Vt({target:this.div_select,props:{notebooks:this.notebooks}}),this.component_select.$on("openSelector",this.updateDiaryStatus_.bind(this)),this.component_select.$on("openDiary",async i=>{await ft(i.detail.notebook),this.updateDiaryStatus_()}),k.clientApi.addToolbarRight(this.div_select),await this.updateDiaryStatus_(),this.notebooks.length>0&&(this.component_select.$set({selected:this.notebooks[0].id}),P.settings.OpenOnStart===!0&&ft(this.notebooks[0]));let n=performance.now();h(`Onload, 耗时: ${n-t} ms`)}initSetting(){this.div_setting=document.createElement("div"),this.component_setting=new ne({target:this.div_setting,props:{contents:I.Setting}}),this.registerSettingRender(t=>{t.appendChild(this.div_setting)}),this.component_setting.$on("updateAll",()=>{this.updateAll()})}async initNotebooks(){let n=0;for(;n<5;){let i=await ut();if(i!=null){this.notebooks=i;break}else await new Promise(o=>setTimeout(o,1e3));n++}}async updateAll(){h("updateAll");let t=await ut();this.notebooks=t||[],this.component_select.$set({notebooks:this.notebooks}),await this.updateDiaryStatus_(),Q(I.UpdateAll,"info",2500)}async updateDiaryStatus_(){h("updateDiaryStatus");let t=new Set;this.notebooks.forEach(o=>{t.add(o.dailynotePath)});let n=new Map,i=0;for(const o of t){let a=await Ot(o);if(a.length>0){let l=a.map(s=>s.box);l.forEach(s=>{n.set(s,!0)}),i+=l.length,h(`${o} 共 ${l.length} 篇`)}}this.component_select.$set({diaryStatus:n}),h(`当前日记共 ${i} 篇`)}onunload(){h("plugin unload"),this.component_select.$destroy(),this.div_select.remove()}}module.exports=ue;
