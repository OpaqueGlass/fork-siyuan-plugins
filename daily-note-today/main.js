"use strict";const h=require("siyuan");function w(){}function H(t){return t()}function q(){return Object.create(null)}function E(t){t.forEach(H)}function J(t){return typeof t=="function"}function Z(t,e){return t!=t?e==e:t!==e||t&&typeof t=="object"||typeof t=="function"}function ee(t){return Object.keys(t).length===0}function _(t,e){t.appendChild(e)}function te(t,e,n){const o=ne(t);if(!o.getElementById(e)){const i=b("style");i.id=e,i.textContent=n,oe(o,i)}}function ne(t){if(!t)return document;const e=t.getRootNode?t.getRootNode():t.ownerDocument;return e&&e.host?e:t.ownerDocument}function oe(t,e){return _(t.head||t,e),e.sheet}function O(t,e,n){t.insertBefore(e,n||null)}function D(t){t.parentNode&&t.parentNode.removeChild(t)}function ie(t,e){for(let n=0;n<t.length;n+=1)t[n]&&t[n].d(e)}function b(t){return document.createElement(t)}function v(t){return document.createTextNode(t)}function U(){return v(" ")}function le(){return v("")}function T(t,e,n,o){return t.addEventListener(e,n,o),()=>t.removeEventListener(e,n,o)}function $(t,e,n){n==null?t.removeAttribute(e):t.getAttribute(e)!==n&&t.setAttribute(e,n)}function ae(t){return Array.from(t.childNodes)}function W(t,e){e=""+e,t.data!==e&&(t.data=e)}function j(t,e,n){for(let o=0;o<t.options.length;o+=1){const i=t.options[o];if(i.__value===e){i.selected=!0;return}}(!n||e!==void 0)&&(t.selectedIndex=-1)}function re(t){const e=t.querySelector(":checked");return e&&e.__value}function se(t,e,{bubbles:n=!1,cancelable:o=!1}={}){const i=document.createEvent("CustomEvent");return i.initCustomEvent(t,n,o,e),i}let S;function k(t){S=t}function ce(){if(!S)throw new Error("Function called outside component initialization");return S}function ue(){const t=ce();return(e,n,{cancelable:o=!1}={})=>{const i=t.$$.callbacks[e];if(i){const a=se(e,n,{cancelable:o});return i.slice().forEach(l=>{l.call(t,a)}),!a.defaultPrevented}return!0}}const y=[],B=[];let g=[];const L=[],de=Promise.resolve();let R=!1;function fe(){R||(R=!0,de.then(K))}function P(t){g.push(t)}const C=new Set;let m=0;function K(){if(m!==0)return;const t=S;do{try{for(;m<y.length;){const e=y[m];m++,k(e),_e(e.$$)}}catch(e){throw y.length=0,m=0,e}for(k(null),y.length=0,m=0;B.length;)B.pop()();for(let e=0;e<g.length;e+=1){const n=g[e];C.has(n)||(C.add(n),n())}g.length=0}while(y.length);for(;L.length;)L.pop()();R=!1,C.clear(),k(t)}function _e(t){if(t.fragment!==null){t.update(),E(t.before_update);const e=t.dirty;t.dirty=[-1],t.fragment&&t.fragment.p(t.ctx,e),t.after_update.forEach(P)}}function he(t){const e=[],n=[];g.forEach(o=>t.indexOf(o)===-1?e.push(o):n.push(o)),n.forEach(o=>o()),g=e}const pe=new Set;function me(t,e){t&&t.i&&(pe.delete(t),t.i(e))}function ye(t,e,n,o){const{fragment:i,after_update:a}=t.$$;i&&i.m(e,n),o||P(()=>{const l=t.$$.on_mount.map(H).filter(J);t.$$.on_destroy?t.$$.on_destroy.push(...l):E(l),t.$$.on_mount=[]}),a.forEach(P)}function ge(t,e){const n=t.$$;n.fragment!==null&&(he(n.after_update),E(n.on_destroy),n.fragment&&n.fragment.d(e),n.on_destroy=n.fragment=null,n.ctx=[])}function be(t,e){t.$$.dirty[0]===-1&&(y.push(t),fe(),t.$$.dirty.fill(0)),t.$$.dirty[e/31|0]|=1<<e%31}function ke(t,e,n,o,i,a,l,r=[-1]){const s=S;k(t);const c=t.$$={fragment:null,ctx:[],props:a,update:w,not_equal:i,bound:q(),on_mount:[],on_destroy:[],on_disconnect:[],before_update:[],after_update:[],context:new Map(e.context||(s?s.$$.context:[])),callbacks:q(),dirty:r,skip_bound:!1,root:e.target||s.$$.root};l&&l(c.root);let A=!1;if(c.ctx=n?n(t,e.props||{},(f,N,...d)=>{const p=d.length?d[0]:N;return c.ctx&&i(c.ctx[f],c.ctx[f]=p)&&(!c.skip_bound&&c.bound[f]&&c.bound[f](p),A&&be(t,f)),N}):[],c.update(),A=!0,E(c.before_update),c.fragment=o?o(c.ctx):!1,e.target){if(e.hydrate){const f=ae(e.target);c.fragment&&c.fragment.l(f),f.forEach(D)}else c.fragment&&c.fragment.c();e.intro&&me(t.$$.fragment),ye(t,e.target,e.anchor,e.customElement),K()}k(s)}class we{$destroy(){ge(this,1),this.$destroy=w}$on(e,n){if(!J(n))return w;const o=this.$$.callbacks[e]||(this.$$.callbacks[e]=[]);return o.push(n),()=>{const i=o.indexOf(n);i!==-1&&o.splice(i,1)}}$set(e){this.$$set&&!ee(e)&&(this.$$.skip_bound=!0,this.$$set(e),this.$$.skip_bound=!1)}}const M=h.clientApi.createLogger("OpenDiaryToday");function u(...t){M.info(...t)}function ve(...t){M.error(...t)}function $e(...t){M.warn(...t)}function Se(t){te(t,"svelte-yta1l5","select.svelte-yta1l5{margin:0;padding:0;max-width:8rem !important}")}function F(t,e,n){const o=t.slice();return o[10]=e[n],o}function Ee(t){let e,n,o=t[10].name+"",i,a,l;return{c(){e=b("option"),n=b("span"),i=v(o),a=U(),$(n,"class","b3-menu__label"),e.__value=l=t[10].id,e.value=e.__value,$(e,"class","b3-menu__item")},m(r,s){O(r,e,s),_(e,n),_(n,i),_(e,a)},p(r,s){s&2&&o!==(o=r[10].name+"")&&W(i,o),s&2&&l!==(l=r[10].id)&&(e.__value=l,e.value=e.__value)},d(r){r&&D(e)}}}function De(t){let e,n,o,i=t[10].name+"",a,l,r;return{c(){e=b("option"),n=b("span"),o=v("√"),a=v(i),l=U(),$(n,"class","b3-menu__label"),e.__value=r=t[10].id,e.value=e.__value,$(e,"class","b3-menu__item")},m(s,c){O(s,e,c),_(e,n),_(n,o),_(n,a),_(e,l)},p(s,c){c&2&&i!==(i=s[10].name+"")&&W(a,i),c&2&&r!==(r=s[10].id)&&(e.__value=r,e.value=e.__value)},d(s){s&&D(e)}}}function I(t){let e,n;function o(l,r){return r&6&&(e=null),e==null&&(e=!l[10].closed&&l[2].get(l[10].id)===!0),e?De:Ee}let i=o(t,-1),a=i(t);return{c(){a.c(),n=le()},m(l,r){a.m(l,r),O(l,n,r)},p(l,r){i===(i=o(l,r))&&a?a.p(l,r):(a.d(1),a=i(l),a&&(a.c(),a.m(n.parentNode,n)))},d(l){a.d(l),l&&D(n)}}}function Ae(t){let e,n,o,i=t[1],a=[];for(let l=0;l<i.length;l+=1)a[l]=I(F(t,i,l));return{c(){e=b("select");for(let l=0;l<a.length;l+=1)a[l].c();$(e,"class","toolbar__item b3-tooltips b3-tooltips__se svelte-yta1l5"),t[0]===void 0&&P(()=>t[5].call(e))},m(l,r){O(l,e,r);for(let s=0;s<a.length;s+=1)a[s]&&a[s].m(e,null);j(e,t[0],!0),n||(o=[T(e,"click",t[3]),T(e,"blur",t[4]),T(e,"change",t[5])],n=!0)},p(l,[r]){if(r&6){i=l[1];let s;for(s=0;s<i.length;s+=1){const c=F(l,i,s);a[s]?a[s].p(c,r):(a[s]=I(c),a[s].c(),a[s].m(e,null))}for(;s<a.length;s+=1)a[s].d(1);a.length=i.length}r&3&&j(e,l[0])},i:w,o:w,d(l){l&&D(e),ie(a,l),n=!1,E(o)}}}function Ne(t,e,n){const o=ue();let{notebooks:i=new Array}=e,{diaryStatus:a=new Map}=e,{selected:l=""}=e,r=!0;function s(d){if(u("Event: click"),r)r=!1,A();else{let p=d.target.value;f(p),r=!0}}function c(){u("Event: blur"),r=!0}function A(){u("Event: openNotebook"),o("openSelector")}function f(d){u("Event: openDiary");let p=i.find(V=>V.id===d);o("openDiary",{notebook:p})}function N(){l=re(this),n(0,l),n(1,i)}return t.$$set=d=>{"notebooks"in d&&n(1,i=d.notebooks),"diaryStatus"in d&&n(2,a=d.diaryStatus),"selected"in d&&n(0,l=d.selected)},t.$$.update=()=>{t.$$.dirty&1&&u("当前选中",l)},[l,i,a,s,c,N]}class Pe extends we{constructor(e){super(),ke(this,e,Ne,Ae,Z,{notebooks:1,diaryStatus:2,selected:0},Se)}}var G;let Oe=(G=window.siyuan)==null?void 0:G.config.api.token;async function Te(t,e){let o=await(await fetch(t,{body:JSON.stringify(e),method:"POST",headers:{Authorization:`Token ${Oe}`}})).json();return o&&(o==null?void 0:o.code)===0?o.data:null}const x='/daily note/{{now | date "2006/01"}}/{{now | date "2006-01-02"}}',Ce=new Set(["思源笔记用户指南","SiYuan User Guide"]);async function Y(){try{let e=(await h.serverApi.lsNotebooks("")).notebooks;e=e.filter(o=>!o.closed&&!Ce.has(o.name)),e=e.sort((o,i)=>o.sort-i.sort);let n=e.map(o=>o.name);for(let o of e){let i=await xe(o.id);o.dailynoteSprig=i!=""?i:x,o.dailynotePath=await z(o.dailynoteSprig),o.dailynotePath==""&&($e(`Invalid daily note srpig of ${o.name}`),o.dailynoteSprig=x,o.dailynotePath=await z(x)),u(`${o.name}: ${o.dailynoteSprig} - ${o.dailynotePath}`)}return u(`Read all notebooks: ${n}`),e}catch(t){return ve(t),null}}async function xe(t){return(await h.serverApi.getNotebookConf(t)).conf.dailyNoteSavePath}async function Re(t){return await Te("/api/template/renderSprig",{template:t})}async function z(t){return await Re(t)}async function Q(t,e=null){let n=`select * from blocks where type='d' and hpath = '${t}'`;return e!=null&&(n=`select * from blocks where type='d' and hpath = '${t}' and box = '${e.id}'`),await h.serverApi.sql(n)}async function Me(t,e){u(`Try to create: ${t.name} ${e}`);let n=await h.serverApi.createDocWithMd(t.id,e,"");return u(`Create new diary ${n}`),n}async function X(t){let e=t.dailynotePath;u(`Open ${t.name}/${e}`);let n=await Q(e,t);if(n!=null&&n.length>0){let i=n[0].id;window.open(`siyuan://blocks/${i}`)}else{let o=await Me(t,e);window.open(`siyuan://blocks/${o}`)}}const qe="toolbar__item b3-tooltips b3-tooltips__sw";class je extends h.Plugin{constructor(){super(),u(`Start: ${new Date}`),this.notebooks=[],this.selectFolded=!0,this.div_select=document.createElement("div"),this.div_select.setAttribute("aria-label","Open Today's Diary"),this.div_select.classList.add(...qe.split(/\s/)),this.div_select.style.margin="0 0.5rem",this.div_select.style.padding="0rem 0rem"}async onload(){let e=performance.now();await this.initNotebooks(),this.registerCommand({command:"updateAll",shortcut:"ctrl+alt+u,command+option+u",description:"全局更新",callback:this.updateAll.bind(this)}),this.component_select=new Pe({target:this.div_select,props:{notebooks:this.notebooks}}),this.component_select.$on("openSelector",this.updateDiaryStatus_.bind(this)),this.component_select.$on("openDiary",async o=>{await X(o.detail.notebook),this.updateDiaryStatus_()}),h.clientApi.addToolbarRight(this.div_select),await this.updateDiaryStatus_(),this.notebooks.length>0&&(X(this.notebooks[0]),this.component_select.$set({selected:this.notebooks[0].id}));let n=performance.now();u(`Onload, 耗时: ${n-e} ms`)}async initNotebooks(){let n=0;for(;n<5;){let o=await Y();if(o!=null){this.notebooks=o;break}else await new Promise(i=>setTimeout(i,1e3));n++}}async updateAll(){u("updateAll");let e=await Y();this.notebooks=e||[],this.component_select.$set({notebooks:this.notebooks}),await this.updateDiaryStatus_()}async updateDiaryStatus_(){u("updateDiaryStatus");let e=new Set;this.notebooks.forEach(i=>{e.add(i.dailynotePath)});let n=new Map,o=0;for(const i of e){let a=await Q(i);if(a.length>0){let l=a.map(r=>r.box);l.forEach(r=>{n.set(r,!0)}),o+=l.length,u(`${i} 共 ${l.length} 篇`)}}this.component_select.$set({diaryStatus:n}),u(`当前日记共 ${o} 篇`)}onunload(){u("plugin unload"),this.component_select.$destroy(),this.div_select.remove()}}module.exports=je;
