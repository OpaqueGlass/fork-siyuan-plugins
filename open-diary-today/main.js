"use strict";const b=require("siyuan");function v(){}function I(t){return t()}function M(){return Object.create(null)}function E(t){t.forEach(I)}function X(t){return typeof t=="function"}function Q(t,e){return t!=t?e==e:t!==e||t&&typeof t=="object"||typeof t=="function"}function V(t){return Object.keys(t).length===0}function _(t,e){t.appendChild(e)}function Z(t,e,n){const o=ee(t);if(!o.getElementById(e)){const l=g("style");l.id=e,l.textContent=n,te(o,l)}}function ee(t){if(!t)return document;const e=t.getRootNode?t.getRootNode():t.ownerDocument;return e&&e.host?e:t.ownerDocument}function te(t,e){return _(t.head||t,e),e.sheet}function T(t,e,n){t.insertBefore(e,n||null)}function D(t){t.parentNode&&t.parentNode.removeChild(t)}function ne(t,e){for(let n=0;n<t.length;n+=1)t[n]&&t[n].d(e)}function g(t){return document.createElement(t)}function w(t){return document.createTextNode(t)}function z(){return w(" ")}function oe(){return w("")}function C(t,e,n,o){return t.addEventListener(e,n,o),()=>t.removeEventListener(e,n,o)}function $(t,e,n){n==null?t.removeAttribute(e):t.getAttribute(e)!==n&&t.setAttribute(e,n)}function le(t){return Array.from(t.childNodes)}function G(t,e){e=""+e,t.data!==e&&(t.data=e)}function P(t,e,n){for(let o=0;o<t.options.length;o+=1){const l=t.options[o];if(l.__value===e){l.selected=!0;return}}(!n||e!==void 0)&&(t.selectedIndex=-1)}function ie(t){const e=t.querySelector(":checked");return e&&e.__value}function se(t,e,{bubbles:n=!1,cancelable:o=!1}={}){const l=document.createEvent("CustomEvent");return l.initCustomEvent(t,n,o,e),l}let S;function k(t){S=t}function re(){if(!S)throw new Error("Function called outside component initialization");return S}function ae(){const t=re();return(e,n,{cancelable:o=!1}={})=>{const l=t.$$.callbacks[e];if(l){const s=se(e,n,{cancelable:o});return l.slice().forEach(i=>{i.call(t,s)}),!s.defaultPrevented}return!0}}const m=[],q=[];let y=[];const B=[],ce=Promise.resolve();let R=!1;function ue(){R||(R=!0,ce.then(U))}function O(t){y.push(t)}const x=new Set;let p=0;function U(){if(p!==0)return;const t=S;do{try{for(;p<m.length;){const e=m[p];p++,k(e),de(e.$$)}}catch(e){throw m.length=0,p=0,e}for(k(null),m.length=0,p=0;q.length;)q.pop()();for(let e=0;e<y.length;e+=1){const n=y[e];x.has(n)||(x.add(n),n())}y.length=0}while(m.length);for(;B.length;)B.pop()();R=!1,x.clear(),k(t)}function de(t){if(t.fragment!==null){t.update(),E(t.before_update);const e=t.dirty;t.dirty=[-1],t.fragment&&t.fragment.p(t.ctx,e),t.after_update.forEach(O)}}function fe(t){const e=[],n=[];y.forEach(o=>t.indexOf(o)===-1?e.push(o):n.push(o)),n.forEach(o=>o()),y=e}const _e=new Set;function he(t,e){t&&t.i&&(_e.delete(t),t.i(e))}function pe(t,e,n,o){const{fragment:l,after_update:s}=t.$$;l&&l.m(e,n),o||O(()=>{const i=t.$$.on_mount.map(I).filter(X);t.$$.on_destroy?t.$$.on_destroy.push(...i):E(i),t.$$.on_mount=[]}),s.forEach(O)}function me(t,e){const n=t.$$;n.fragment!==null&&(fe(n.after_update),E(n.on_destroy),n.fragment&&n.fragment.d(e),n.on_destroy=n.fragment=null,n.ctx=[])}function ye(t,e){t.$$.dirty[0]===-1&&(m.push(t),ue(),t.$$.dirty.fill(0)),t.$$.dirty[e/31|0]|=1<<e%31}function be(t,e,n,o,l,s,i,a=[-1]){const r=S;k(t);const c=t.$$={fragment:null,ctx:[],props:s,update:v,not_equal:l,bound:M(),on_mount:[],on_destroy:[],on_disconnect:[],before_update:[],after_update:[],context:new Map(e.context||(r?r.$$.context:[])),callbacks:M(),dirty:a,skip_bound:!1,root:e.target||r.$$.root};i&&i(c.root);let A=!1;if(c.ctx=n?n(t,e.props||{},(f,N,...d)=>{const h=d.length?d[0]:N;return c.ctx&&l(c.ctx[f],c.ctx[f]=h)&&(!c.skip_bound&&c.bound[f]&&c.bound[f](h),A&&ye(t,f)),N}):[],c.update(),A=!0,E(c.before_update),c.fragment=o?o(c.ctx):!1,e.target){if(e.hydrate){const f=le(e.target);c.fragment&&c.fragment.l(f),f.forEach(D)}else c.fragment&&c.fragment.c();e.intro&&he(t.$$.fragment),pe(t,e.target,e.anchor,e.customElement),U()}k(r)}class ge{$destroy(){me(this,1),this.$destroy=v}$on(e,n){if(!X(n))return v;const o=this.$$.callbacks[e]||(this.$$.callbacks[e]=[]);return o.push(n),()=>{const l=o.indexOf(n);l!==-1&&o.splice(l,1)}}$set(e){this.$$set&&!V(e)&&(this.$$.skip_bound=!0,this.$$set(e),this.$$.skip_bound=!1)}}const W=b.clientApi.createLogger("OpenDiaryToday");function u(...t){W.info(...t)}function ke(...t){W.error(...t)}function ve(t){Z(t,"svelte-yta1l5","select.svelte-yta1l5{margin:0;padding:0;max-width:8rem !important}")}function F(t,e,n){const o=t.slice();return o[10]=e[n],o}function we(t){let e,n,o=t[10].name+"",l,s,i;return{c(){e=g("option"),n=g("span"),l=w(o),s=z(),$(n,"class","b3-menu__label"),e.__value=i=t[10].id,e.value=e.__value,$(e,"class","b3-menu__item")},m(a,r){T(a,e,r),_(e,n),_(n,l),_(e,s)},p(a,r){r&2&&o!==(o=a[10].name+"")&&G(l,o),r&2&&i!==(i=a[10].id)&&(e.__value=i,e.value=e.__value)},d(a){a&&D(e)}}}function $e(t){let e,n,o,l=t[10].name+"",s,i,a;return{c(){e=g("option"),n=g("span"),o=w("√"),s=w(l),i=z(),$(n,"class","b3-menu__label"),e.__value=a=t[10].id,e.value=e.__value,$(e,"class","b3-menu__item")},m(r,c){T(r,e,c),_(e,n),_(n,o),_(n,s),_(e,i)},p(r,c){c&2&&l!==(l=r[10].name+"")&&G(s,l),c&2&&a!==(a=r[10].id)&&(e.__value=a,e.value=e.__value)},d(r){r&&D(e)}}}function L(t){let e,n;function o(i,a){return a&6&&(e=null),e==null&&(e=!i[10].closed&&i[2].get(i[10].id)===!0),e?$e:we}let l=o(t,-1),s=l(t);return{c(){s.c(),n=oe()},m(i,a){s.m(i,a),T(i,n,a)},p(i,a){l===(l=o(i,a))&&s?s.p(i,a):(s.d(1),s=l(i),s&&(s.c(),s.m(n.parentNode,n)))},d(i){s.d(i),i&&D(n)}}}function Se(t){let e,n,o,l=t[1],s=[];for(let i=0;i<l.length;i+=1)s[i]=L(F(t,l,i));return{c(){e=g("select");for(let i=0;i<s.length;i+=1)s[i].c();$(e,"class","toolbar__item b3-tooltips b3-tooltips__se svelte-yta1l5"),t[0]===void 0&&O(()=>t[5].call(e))},m(i,a){T(i,e,a);for(let r=0;r<s.length;r+=1)s[r]&&s[r].m(e,null);P(e,t[0],!0),n||(o=[C(e,"click",t[3]),C(e,"blur",t[4]),C(e,"change",t[5])],n=!0)},p(i,[a]){if(a&6){l=i[1];let r;for(r=0;r<l.length;r+=1){const c=F(i,l,r);s[r]?s[r].p(c,a):(s[r]=L(c),s[r].c(),s[r].m(e,null))}for(;r<s.length;r+=1)s[r].d(1);s.length=l.length}a&3&&P(e,i[0])},i:v,o:v,d(i){i&&D(e),ne(s,i),n=!1,E(o)}}}function Ee(t,e,n){const o=ae();let{notebooks:l=new Array}=e,{diaryStatus:s=new Map}=e,{selected:i=""}=e,a=!0;function r(d){if(u("Event: click"),a)a=!1,A();else{let h=d.target.value;f(h),a=!0}}function c(){u("Event: blur"),a=!0}function A(){u("Event: openNotebook"),o("openSelector")}function f(d){u("Event: openDiary");let h=l.find(K=>K.id===d);o("openDiary",{notebook:h})}function N(){i=ie(this),n(0,i),n(1,l)}return t.$$set=d=>{"notebooks"in d&&n(1,l=d.notebooks),"diaryStatus"in d&&n(2,s=d.diaryStatus),"selected"in d&&n(0,i=d.selected)},t.$$.update=()=>{t.$$.dirty&1&&u("当前选中",i)},[i,l,s,r,c,N]}class De extends ge{constructor(e){super(),be(this,e,Ee,Se,Q,{notebooks:1,diaryStatus:2,selected:0},ve)}}function H(){const t=new Date,e=t.getFullYear(),n=String(t.getMonth()+1).padStart(2,"0"),o=String(t.getDate()).padStart(2,"0"),l=`${e}-${n}-${o}`;return`/daily note/${e}/${n}/${l}`}const Ae=new Set(["思源笔记用户指南","SiYuan User Guide"]);async function j(){try{let e=(await b.serverApi.lsNotebooks("")).notebooks;e=e.filter(o=>!o.closed&&!Ae.has(o.name)),e=e.sort((o,l)=>o.sort-l.sort);let n=e.map(o=>o.name);return u(`Read all notebooks: ${n}`),e}catch(t){return ke(t),null}}async function J(t,e=null){let n=`select * from blocks where type='d' and hpath = '${t}'`;return e!=null&&(n=`select * from blocks where type='d' and hpath = '${t}' and box = '${e.id}'`),await b.serverApi.sql(n)}async function Ne(t,e){u(`Try to create: ${t.name} ${e}`);let n=await b.serverApi.createDocWithMd(t.id,e,"");return u(`Create new diary ${n}`),n}async function Y(t){let e=H();u(`Open ${t.name}${e}`);let n=await J(e,t);if(n!=null&&n.length>0){let l=n[0].id;window.open(`siyuan://blocks/${l}`)}else{let o=await Ne(t,e);window.open(`siyuan://blocks/${o}`)}}const Oe="toolbar__item b3-tooltips b3-tooltips__sw";class Te extends b.Plugin{constructor(){super(),u(`Start: ${new Date}`),this.notebooks=[],this.selectFolded=!0,this.div_select=document.createElement("div"),this.div_select.setAttribute("aria-label","Open Today's Diary"),this.div_select.classList.add(...Oe.split(/\s/)),this.div_select.style.margin="0 0.5rem",this.div_select.style.padding="0rem 0rem"}async onload(){let e=performance.now();await this.initNotebooks(),this.registerCommand({command:"updateAll",shortcut:"ctrl+alt+u,command+option+u",description:"全局更新",callback:this.updateAll.bind(this)}),this.component_select=new De({target:this.div_select,props:{notebooks:this.notebooks}}),this.component_select.$on("openSelector",this.updateDiaryStatus_.bind(this)),this.component_select.$on("openDiary",async o=>{await Y(o.detail.notebook),this.updateDiaryStatus_()}),b.clientApi.addToolbarRight(this.div_select),await this.updateDiaryStatus_(),this.notebooks.length>0&&(Y(this.notebooks[0]),this.component_select.$set({selected:this.notebooks[0].id}));let n=performance.now();u(`Onload, 耗时: ${n-e} ms`)}async initNotebooks(){let n=0;for(;n<5;){let o=await j();if(o!=null){this.notebooks=o;break}else await new Promise(l=>setTimeout(l,1e3));n++}}async updateAll(){u("updateAll");let e=await j();this.notebooks=e||[],this.component_select.$set({notebooks:this.notebooks}),await this.updateDiaryStatus_()}async updateDiaryStatus_(){u("updateDiaryStatus");let e=H(),n=await J(e);if(n.length>0){let o=n.map(i=>i.box),l=o.length,s=new Map;o.forEach(i=>{s.set(i,!0)}),this.component_select.$set({diaryStatus:s}),u(`'当前日记共 ${l} 篇`)}}onunload(){u("plugin unload"),this.component_select.$destroy(),this.div_select.remove()}}module.exports=Te;
