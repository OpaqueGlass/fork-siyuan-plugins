"use strict";const b=require("siyuan");function k(){}function I(t){return t()}function R(){return Object.create(null)}function $(t){t.forEach(I)}function Y(t){return typeof t=="function"}function K(t,e){return t!=t?e==e:t!==e||t&&typeof t=="object"||typeof t=="function"}function Q(t){return Object.keys(t).length===0}function f(t,e){t.appendChild(e)}function U(t,e,n){const o=V(t);if(!o.getElementById(e)){const l=y("style");l.id=e,l.textContent=n,Z(o,l)}}function V(t){if(!t)return document;const e=t.getRootNode?t.getRootNode():t.ownerDocument;return e&&e.host?e:t.ownerDocument}function Z(t,e){return f(t.head||t,e),e.sheet}function N(t,e,n){t.insertBefore(e,n||null)}function S(t){t.parentNode&&t.parentNode.removeChild(t)}function ee(t,e){for(let n=0;n<t.length;n+=1)t[n]&&t[n].d(e)}function y(t){return document.createElement(t)}function v(t){return document.createTextNode(t)}function X(){return v(" ")}function te(){return v("")}function C(t,e,n,o){return t.addEventListener(e,n,o),()=>t.removeEventListener(e,n,o)}function w(t,e,n){n==null?t.removeAttribute(e):t.getAttribute(e)!==n&&t.setAttribute(e,n)}function ne(t){return Array.from(t.childNodes)}function z(t,e){e=""+e,t.data!==e&&(t.data=e)}function M(t,e,n){for(let o=0;o<t.options.length;o+=1){const l=t.options[o];if(l.__value===e){l.selected=!0;return}}(!n||e!==void 0)&&(t.selectedIndex=-1)}function oe(t){const e=t.querySelector(":checked");return e&&e.__value}function le(t,e,{bubbles:n=!1,cancelable:o=!1}={}){const l=document.createEvent("CustomEvent");return l.initCustomEvent(t,n,o,e),l}let D;function g(t){D=t}function ie(){if(!D)throw new Error("Function called outside component initialization");return D}function se(){const t=ie();return(e,n,{cancelable:o=!1}={})=>{const l=t.$$.callbacks[e];if(l){const s=le(e,n,{cancelable:o});return l.slice().forEach(i=>{i.call(t,s)}),!s.defaultPrevented}return!0}}const p=[],P=[];let m=[];const q=[],re=Promise.resolve();let x=!1;function ae(){x||(x=!0,re.then(W))}function A(t){m.push(t)}const T=new Set;let h=0;function W(){if(h!==0)return;const t=D;do{try{for(;h<p.length;){const e=p[h];h++,g(e),ce(e.$$)}}catch(e){throw p.length=0,h=0,e}for(g(null),p.length=0,h=0;P.length;)P.pop()();for(let e=0;e<m.length;e+=1){const n=m[e];T.has(n)||(T.add(n),n())}m.length=0}while(p.length);for(;q.length;)q.pop()();x=!1,T.clear(),g(t)}function ce(t){if(t.fragment!==null){t.update(),$(t.before_update);const e=t.dirty;t.dirty=[-1],t.fragment&&t.fragment.p(t.ctx,e),t.after_update.forEach(A)}}function ue(t){const e=[],n=[];m.forEach(o=>t.indexOf(o)===-1?e.push(o):n.push(o)),n.forEach(o=>o()),m=e}const de=new Set;function fe(t,e){t&&t.i&&(de.delete(t),t.i(e))}function _e(t,e,n,o){const{fragment:l,after_update:s}=t.$$;l&&l.m(e,n),o||A(()=>{const i=t.$$.on_mount.map(I).filter(Y);t.$$.on_destroy?t.$$.on_destroy.push(...i):$(i),t.$$.on_mount=[]}),s.forEach(A)}function he(t,e){const n=t.$$;n.fragment!==null&&(ue(n.after_update),$(n.on_destroy),n.fragment&&n.fragment.d(e),n.on_destroy=n.fragment=null,n.ctx=[])}function pe(t,e){t.$$.dirty[0]===-1&&(p.push(t),ae(),t.$$.dirty.fill(0)),t.$$.dirty[e/31|0]|=1<<e%31}function me(t,e,n,o,l,s,i,a=[-1]){const r=D;g(t);const c=t.$$={fragment:null,ctx:[],props:s,update:k,not_equal:l,bound:R(),on_mount:[],on_destroy:[],on_disconnect:[],before_update:[],after_update:[],context:new Map(e.context||(r?r.$$.context:[])),callbacks:R(),dirty:a,skip_bound:!1,root:e.target||r.$$.root};i&&i(c.root);let E=!1;if(c.ctx=n?n(t,e.props||{},(d,O,...u)=>{const _=u.length?u[0]:O;return c.ctx&&l(c.ctx[d],c.ctx[d]=_)&&(!c.skip_bound&&c.bound[d]&&c.bound[d](_),E&&pe(t,d)),O}):[],c.update(),E=!0,$(c.before_update),c.fragment=o?o(c.ctx):!1,e.target){if(e.hydrate){const d=ne(e.target);c.fragment&&c.fragment.l(d),d.forEach(S)}else c.fragment&&c.fragment.c();e.intro&&fe(t.$$.fragment),_e(t,e.target,e.anchor,e.customElement),W()}g(r)}class ye{$destroy(){he(this,1),this.$destroy=k}$on(e,n){if(!Y(n))return k;const o=this.$$.callbacks[e]||(this.$$.callbacks[e]=[]);return o.push(n),()=>{const l=o.indexOf(n);l!==-1&&o.splice(l,1)}}$set(e){this.$$set&&!Q(e)&&(this.$$.skip_bound=!0,this.$$set(e),this.$$.skip_bound=!1)}}function ge(t){U(t,"svelte-yta1l5","select.svelte-yta1l5{margin:0;padding:0;max-width:8rem !important}")}function B(t,e,n){const o=t.slice();return o[10]=e[n],o}function be(t){let e,n,o=t[10].name+"",l,s,i;return{c(){e=y("option"),n=y("span"),l=v(o),s=X(),w(n,"class","b3-menu__label"),e.__value=i=t[10].id,e.value=e.__value,w(e,"class","b3-menu__item")},m(a,r){N(a,e,r),f(e,n),f(n,l),f(e,s)},p(a,r){r&2&&o!==(o=a[10].name+"")&&z(l,o),r&2&&i!==(i=a[10].id)&&(e.__value=i,e.value=e.__value)},d(a){a&&S(e)}}}function ke(t){let e,n,o,l=t[10].name+"",s,i,a;return{c(){e=y("option"),n=y("span"),o=v("√"),s=v(l),i=X(),w(n,"class","b3-menu__label"),e.__value=a=t[10].id,e.value=e.__value,w(e,"class","b3-menu__item")},m(r,c){N(r,e,c),f(e,n),f(n,o),f(n,s),f(e,i)},p(r,c){c&2&&l!==(l=r[10].name+"")&&z(s,l),c&2&&a!==(a=r[10].id)&&(e.__value=a,e.value=e.__value)},d(r){r&&S(e)}}}function F(t){let e,n;function o(i,a){return a&6&&(e=null),e==null&&(e=!i[10].closed&&i[2].get(i[10].id)===!0),e?ke:be}let l=o(t,-1),s=l(t);return{c(){s.c(),n=te()},m(i,a){s.m(i,a),N(i,n,a)},p(i,a){l===(l=o(i,a))&&s?s.p(i,a):(s.d(1),s=l(i),s&&(s.c(),s.m(n.parentNode,n)))},d(i){s.d(i),i&&S(n)}}}function ve(t){let e,n,o,l=t[1],s=[];for(let i=0;i<l.length;i+=1)s[i]=F(B(t,l,i));return{c(){e=y("select");for(let i=0;i<s.length;i+=1)s[i].c();w(e,"class","toolbar__item b3-tooltips b3-tooltips__se svelte-yta1l5"),t[0]===void 0&&A(()=>t[5].call(e))},m(i,a){N(i,e,a);for(let r=0;r<s.length;r+=1)s[r]&&s[r].m(e,null);M(e,t[0],!0),n||(o=[C(e,"click",t[3]),C(e,"blur",t[4]),C(e,"change",t[5])],n=!0)},p(i,[a]){if(a&6){l=i[1];let r;for(r=0;r<l.length;r+=1){const c=B(i,l,r);s[r]?s[r].p(c,a):(s[r]=F(c),s[r].c(),s[r].m(e,null))}for(;r<s.length;r+=1)s[r].d(1);s.length=l.length}a&3&&M(e,i[0])},i:k,o:k,d(i){i&&S(e),ee(s,i),n=!1,$(o)}}}function we(t,e,n){const o=se();let{notebooks:l=new Array}=e,{diaryStatus:s=new Map}=e,{selected:i=""}=e,a=!0;function r(u){if(console.log("[OpenDiary] Event: click"),a)a=!1,E();else{let _=u.target.value;d(_),a=!0}}function c(){console.log("[OpenDiary] Event: blur"),a=!0}function E(){console.log("[OpenDiary] Event: openNotebook"),o("openSelector")}function d(u){console.log("[OpenDiary] Event: openDiary");let _=l.find(J=>J.id===u);o("openDiary",{notebook:_})}function O(){i=oe(this),n(0,i),n(1,l)}return t.$$set=u=>{"notebooks"in u&&n(1,l=u.notebooks),"diaryStatus"in u&&n(2,s=u.diaryStatus),"selected"in u&&n(0,i=u.selected)},t.$$.update=()=>{t.$$.dirty&1&&console.log("[OpenDiary] 当前选中",i)},[i,l,s,r,c,O]}class De extends ye{constructor(e){super(),me(this,e,we,ve,K,{notebooks:1,diaryStatus:2,selected:0},ge)}}function G(){const t=new Date,e=t.getFullYear(),n=String(t.getMonth()+1).padStart(2,"0"),o=String(t.getDate()).padStart(2,"0"),l=`${e}-${n}-${o}`;return`/daily note/${e}/${n}/${l}`}async function j(){try{let e=(await b.serverApi.lsNotebooks("")).notebooks;e=e.filter(o=>o.name!=="思源笔记用户指南"&&o.closed===!1),e=e.sort((o,l)=>o.sort-l.sort);let n=e.map(o=>o.name);return console.log(`[OpenDiary]: Read all notebooks: ${n}`),e}catch(t){return console.log(t),null}}async function H(t,e=null){let n=`select * from blocks where type='d' and hpath = '${t}'`;return e!=null&&(n=`select * from blocks where type='d' and hpath = '${t}' and box = '${e.id}'`),await b.serverApi.sql(n)}async function $e(t,e){console.log(`[OpenDiary]: Try to create: ${t.name} ${e}`);let n=await b.serverApi.createDocWithMd(t.id,e,"");return console.log(`[OpenDiary]: Create new diary ${n}`),n}async function L(t){let e=G();console.log(`[OpenDiary]: Open ${t.name}${e}`);let n=await H(e,t);if(n!=null&&n.length>0){let l=n[0].id;window.open(`siyuan://blocks/${l}`)}else{let o=await $e(t,e);window.open(`siyuan://blocks/${o}`)}}const Se="toolbar__item b3-tooltips b3-tooltips__sw";class Ee extends b.Plugin{constructor(){super(),console.log(`[OpenDiary]: Start: ${new Date}`),this.notebooks=[],this.selectFolded=!0,this.div_select=document.createElement("div"),this.div_select.setAttribute("aria-label","Open Today's Diary"),this.div_select.classList.add(...Se.split(/\s/)),this.div_select.style.margin="0 0.5rem",this.div_select.style.padding="0rem 0rem"}async onload(){let e=performance.now();await this.initNotebooks(),this.registerCommand({command:"updateAll",shortcut:"ctrl+alt+u,command+option+u",description:"全局更新",callback:this.updateAll.bind(this)}),this.component_select=new De({target:this.div_select,props:{notebooks:this.notebooks}}),this.component_select.$on("openSelector",this.updateDiaryStatus_.bind(this)),this.component_select.$on("openDiary",async o=>{await L(o.detail.notebook),this.updateDiaryStatus_()}),b.clientApi.addToolbarRight(this.div_select),await this.updateDiaryStatus_(),this.notebooks.length>0&&(L(this.notebooks[0]),this.component_select.$set({selected:this.notebooks[0].id}));let n=performance.now();console.log(`[OpenDiary]: onload, 耗时: ${n-e} ms`)}async initNotebooks(){let n=0;for(;n<5;){let o=await j();if(o!=null){this.notebooks=o;break}else await new Promise(l=>setTimeout(l,1e3));n++}}async updateAll(){console.log("[OpenDiary]: updateAll");let e=await j();this.notebooks=e||[],this.component_select.$set({notebooks:this.notebooks}),await this.updateDiaryStatus_()}async updateDiaryStatus_(){console.log("[OpenDiary]: updateDiaryStatus");let e=G(),n=await H(e);if(n.length>0){let o=n.map(i=>i.box),l=o.length,s=new Map;o.forEach(i=>{s.set(i,!0)}),console.log("update",this.component_select),this.component_select.$set({diaryStatus:s}),console.log(`'[OpenDiary]: 当前日记共 ${l} 篇`)}}onunload(){console.log("[OpenDiary]: plugin unload"),this.component_select.$destroy(),this.div_select.remove()}}module.exports=Ee;
